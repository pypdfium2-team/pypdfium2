# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

pypdfium2 is a Python binding to PDFium, a powerful PDF rendering library. It provides both raw ctypes bindings and a high-level helper API for PDF processing, rendering, and manipulation. The project uses custom setup infrastructure to bundle PDFium binaries and generate bindings automatically.

## Common Commands

### Development Setup
```bash
# Install in development mode with default setup (downloads prebuilt binaries)
pip install -e .

# Install with verbose output to see setup process
pip install -e . -v

# Update PDFium binaries to latest version
just update

# Verify downloaded binaries
just update-verify
```

### Building from Source
```bash
# Native build (Linux-focused, uses system tools)
just build-native --compiler gcc

# Toolchained build (macOS/Windows, uses Google's toolchain)
just build-toolchained

# Clean build artifacts
just clean

# Build and package for PyPI
just packaging-pypi
```

### Testing
```bash
# Run all tests
just test

# Run specific test file
just test test_page.py

# Run with coverage
just coverage

# Run coverage for core functionality
just coverage-core
```

### Documentation
```bash
# Build HTML documentation
just docs-build

# Open docs in browser
just docs-open

# Clean built docs
just docs-clean
```

### Code Quality
```bash
# Run code quality checks
just check

# Check distribution packages
just distcheck
```

## Architecture

### Core Components

**Setup Infrastructure** (`setupsrc/pypdfium2_setup/`):
- `base.py`: Core setup logic, platform detection, and configuration
- `update.py`: Downloads and manages PDFium binaries from pdfium-binaries
- `build_native.py`: Native PDFium build for Linux using system tools
- `build_toolchained.py`: Toolchained build using Google's build system
- `craft.py`: Creates platform-specific wheel packages
- `emplace.py`: Sets up staging directories and generates bindings

**Source Code** (`src/`):
- `pypdfium2/`: High-level helper API with classes like `PdfDocument`, `PdfPage`
- `pypdfium2_raw/`: Raw ctypes bindings generated by ctypesgen
- Bindings are auto-generated from PDFium headers using ctypesgen fork

**Build System**:
- Custom setuptools integration in `setup.py`
- Platform-specific wheel tagging and binary distribution
- Support for multiple PDFium sources (prebuilt, system, sourcebuild)

### Key Technical Details

**Platform Support Strategy**:
1. **Prebuilt Binaries**: Default approach using pdfium-binaries project
2. **System Integration**: Can bind against system-installed PDFium
3. **Source Builds**: Native and toolchained approaches for full control

**Environment Variables**:
- `PDFIUM_PLATFORM`: Controls PDFium source (auto, system-search, sourcebuild, etc.)
- `PDFIUM_BINDINGS`: Can override to use reference bindings
- `PYPDFIUM_MODULES`: Controls which modules to include (raw, helpers)

**Build Configuration**:
- Uses custom `BinaryDistribution` class for proper wheel tagging
- Supports cross-compilation with `CROSS_TAG` environment variable
- Automatic ctypesgen binding generation from PDFium headers

### Dependencies

**Build Dependencies**:
- `ctypesgen` (pypdfium2-team fork): Binding generation
- `setuptools >= v70.1.0`: Python packaging
- System C preprocessor (gcc/clang)

**Optional Runtime Dependencies**:
- `Pillow`: Image processing helpers
- `NumPy`: Array helpers for bitmap data
- `opencv-python`: Alternative imaging support

## Development Workflow

### Adding New Features
1. Modify helper classes in `src/pypdfium2/`
2. Add raw API usage in `src/pypdfium2_raw/` if needed
3. Write tests in `tests/` directory
4. Update documentation if public API changes

### Building and Testing
1. Use `just test` for quick verification
2. For full CI simulation: `just packaging-pypi`
3. Test multiple platforms using cibuildwheel configuration

### Release Process
1. Update changelog in `docs/devel/changelog_staging.md`
2. Run autorelease script: `python setupsrc/pypdfium2_setup/autorelease.py --register`
3. CI handles automated wheel building and PyPI upload

## File Structure Notes

- `data/`: Staging area for PDFium binaries and generated files
- `sbuild/`: Source build workspace (PDFium checkout and build artifacts)
- `tests/`: Comprehensive test suite with PDF resources
- `utils/`: Helper utilities for development tasks
- `BUILD_LICENSES/`: Aggregated dependency licenses for distribution

## Platform Considerations

The project supports multiple platforms with different build strategies:
- **Linux**: Native build with system libraries, or toolchained
- **macOS**: Toolchained build with Google's build system
- **Windows**: Toolchained build with Visual Studio

Each platform has specific dependencies and toolchain requirements documented in the README and GitHub workflows.