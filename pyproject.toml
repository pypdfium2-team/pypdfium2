# SPDX-FileCopyrightText: 2025 geisserml <geisserml@gmail.com>
# SPDX-License-Identifier: Apache-2.0 OR BSD-3-Clause

[build-system]
build-backend = "setuptools.build_meta"
requires = [
    "setuptools",
    "packaging",
    # XXX dependence on wheel is historical, with setuptools >= v70.1.0 this is not needed anymore
    "wheel !=0.38.0, !=0.38.1",
    "ctypesgen @ git+https://github.com/pypdfium2-team/ctypesgen@pypdfium2",
]

[tool.cibuildwheel]
build-frontend = "build"
test-command = [
    "python -m pypdfium2 --version",
    "python {project}/conda/raw/minitest.py",
]

[[tool.cibuildwheel.overrides]]
# run actual test suite on platforms that have pillow and numpy prebuilds on PyPI
select = "manylinux_{x86_64,aarch64}"
test-requires = ["pytest", "pillow", "numpy"]
inherit.test-command = "append"
test-command = [
    "python -m pytest {project}/tests",
]

[tool.cibuildwheel.environment]
PDFIUM_PLATFORM = "sourcebuild-native"
BUILD_PARAMS = "vendor_deps={'icu'}"

[tool.cibuildwheel.linux]
before-all = [
    "dnf -y install ninja-build freetype-devel lcms2-devel libjpeg-devel openjpeg2-devel libpng-devel libtiff-devel zlib-devel glib2-devel",
    "sh -c 'dnf -y install gn || true'",  # not manylinux_{riscv64,loongarch64}
]

[[tool.cibuildwheel.overrides]]
select = "*-musllinux*"
before-all = [
    "apk add gn ninja-build freetype-dev lcms2-dev jpeg-dev openjpeg-dev libpng-dev tiff-dev zlib-dev glib-dev",
]

[[tool.cibuildwheel.overrides]]
select = "*-manylinux_{aarch64,loongarch64}"
inherit.before-all = "append"
before-all = [
    "export PREFIX=$(python {package}/utils/get_gcc_prefix.py)",
    "ln -s /opt/rh/gcc-toolset-14/root/bin/gcc /opt/rh/gcc-toolset-14/root/bin/$PREFIX-gcc",
    "ln -s /opt/rh/gcc-toolset-14/root/bin/g++ /opt/rh/gcc-toolset-14/root/bin/$PREFIX-g++",
    "ln -s /opt/rh/gcc-toolset-14/root/bin/nm /opt/rh/gcc-toolset-14/root/bin/$PREFIX-nm",
    "ln -s /opt/rh/gcc-toolset-14/root/bin/readelf /opt/rh/gcc-toolset-14/root/bin/$PREFIX-readelf",
]

[[tool.cibuildwheel.overrides]]
select = "*-manylinux_riscv64"
inherit.before-all = "append"
before-all = [
    "export PREFIX=$(python {package}/utils/get_gcc_prefix.py)",
    "ln -s /usr/bin/gcc /usr/bin/$PREFIX-gcc",
    "ln -s /usr/bin/g++ /usr/bin/$PREFIX-g++",
    "ln -s /usr/bin/nm /usr/bin/$PREFIX-nm",
    "ln -s /usr/bin/readelf /usr/bin/$PREFIX-readelf",
]

[[tool.cibuildwheel.overrides]]
select = "*-musllinux_{aarch64,armv7l,riscv64,loongarch64}"
inherit.before-all = "append"
before-all = [
    "export PREFIX=$(python {package}/utils/get_gcc_prefix.py)",
    "ln -s /usr/bin/gcc /usr/bin/$PREFIX-gcc",
    "ln -s /usr/bin/g++ /usr/bin/$PREFIX-g++",
    "ln -s /usr/bin/nm /usr/bin/$PREFIX-nm",
    "ln -s /usr/bin/readelf /usr/bin/$PREFIX-readelf",
]

[[tool.cibuildwheel.overrides]]
select = "*-manylinux_loongarch64"
inherit.before-all = "append"
before-all = [
    "curl -L 'https://github.com/loong64/gn/releases/download/2024.12/gn-linux-loong64.tar.gz' | tar xz -C /usr/local/bin",
]

[[tool.cibuildwheel.overrides]]
select = "*-manylinux_riscv64"
inherit.before-all = "append"
before-all = [
    "export GN_ARCHIVE='./gn-linux-riscv64.zip'",
    "curl -L -o '$GN_ARCHIVE' 'https://chrome-infra-packages.appspot.com/dl/gn/gn/linux-riscv64/+/latest'",
    "unzip -j '$GN_ARCHIVE' gn -d /usr/local/bin",
    "unlink '$GN_ARCHIVE'",
]

# macOS is work in progress

[tool.cibuildwheel.macos]
before-all = [
    "sh -c 'brew update || true'",
    "sh -c 'brew install ninja freetype lcms2 jpeg-turbo openjpeg libpng libtiff zlib glib || true'",
]

[[tool.cibuildwheel.overrides]]
select = "*-macosx_*"
environment = {PDFIUM_PLATFORM="sourcebuild-native", BUILD_PARAMS="vendor_deps={'icu'}, compiler='clang', clang_path='/usr'"}

[[tool.cibuildwheel.overrides]]
select = "*-macosx_x86_64"
inherit.before-all = "append"
before-all = [
    "export GN_ARCHIVE='./gn-mac-amd64.zip'",
    "curl -L -o '$GN_ARCHIVE' 'https://chrome-infra-packages.appspot.com/dl/gn/gn/mac-amd64/+/latest'",
    "unzip -j '$GN_ARCHIVE' gn -d /usr/local/bin",
    "unlink '$GN_ARCHIVE'",
]
inherit.environment = "append"
environment = {MACOSX_DEPLOYMENT_TARGET="13.0", SYSTEM_VERSION_COMPAT=0}

[[tool.cibuildwheel.overrides]]
select = "*-macosx_arm64"
inherit.before-all = "append"
before-all = [
    "export GN_ARCHIVE='./gn-mac-arm64.zip'",
    "curl -L -o '$GN_ARCHIVE' 'https://chrome-infra-packages.appspot.com/dl/gn/gn/mac-arm64/+/latest'",
    "unzip -j '$GN_ARCHIVE' gn -d /usr/local/bin",
    "unlink '$GN_ARCHIVE'",
]
inherit.environment = "append"
environment = {MACOSX_DEPLOYMENT_TARGET="14.0"}
