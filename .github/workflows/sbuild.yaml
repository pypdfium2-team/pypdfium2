# SPDX-FileCopyrightText: 2025 geisserml <geisserml@gmail.com>
# SPDX-License-Identifier: Apache-2.0 OR BSD-3-Clause

name: Sourcebuild

on:
  workflow_dispatch:
    inputs:
      linux:
        type: boolean
        default: true
      macos:
        type: boolean
        default: true
      windows:
        type: boolean
        default: true
      py_version:
        type: string
        default: '3.12'
      glibc_tag:
        type: string
        default: 'manylinux_2_17'

jobs:
  
  linux_x64:
    if: ${{ inputs.linux }}
    uses: ./.github/workflows/sbuild-one.yaml
    with:
      os: ubuntu-latest
      cross_tag: ${{ inputs.glibc_tag }}_x86_64
      is_cross: false
      artifact_name: linux_x64
      py_version: ${{ inputs.py_version }}
  
  linux_x86:
    if: ${{ inputs.linux }}
    uses: ./.github/workflows/sbuild-one.yaml
    with:
      os: ubuntu-latest
      params: '--target-cpu x86'
      cross_deps: 'g++-multilib'
      cross_tag: ${{ inputs.glibc_tag }}_i686
      is_cross: true
      artifact_name: linux-cross_x86
      py_version: ${{ inputs.py_version }}
  
  linux_arm64:
    if: ${{ inputs.linux }}
    uses: ./.github/workflows/sbuild-one.yaml
    with:
      os: ubuntu-latest
      params: '--target-cpu arm64'
      cross_deps: 'libc6-i386 gcc-10-multilib g++-10-aarch64-linux-gnu gcc-10-aarch64-linux-gnu'
      cross_tag: ${{ inputs.glibc_tag }}_aarch64
      is_cross: true
      artifact_name: linux-cross_arm64
      py_version: ${{ inputs.py_version }}
  
  linux_armv7l:
    if: ${{ inputs.linux }}
    uses: ./.github/workflows/sbuild-one.yaml
    with:
      os: ubuntu-latest
      params: '--target-cpu arm'
      cross_deps: 'libc6-i386 gcc-10-multilib g++-10-arm-linux-gnueabihf gcc-10-arm-linux-gnueabihf'
      cross_tag: ${{ inputs.glibc_tag }}_armv7l
      is_cross: true
      artifact_name: linux-cross_armv7l
      py_version: ${{ inputs.py_version }}
    
  macos_x64:
    if: ${{ inputs.macos }}
    uses: ./.github/workflows/sbuild-one.yaml
    with:
      os: macos-latest  # arm64 host
      params: '--target-cpu x64'
      cross_tag: macosx_11_0_x86_64
      is_cross: true
      artifact_name: macos-cross_x64
      py_version: ${{ inputs.py_version }}
  
  macos_arm64:
    if: ${{ inputs.macos }}
    uses: ./.github/workflows/sbuild-one.yaml
    with:
      os: macos-latest
      cross_tag: macosx_11_0_arm64
      is_cross: false
      artifact_name: macos_arm64
      py_version: ${{ inputs.py_version }}
  
  windows_x64:
    if: ${{ inputs.windows }}
    uses: ./.github/workflows/sbuild-one.yaml
    with:
      os: windows-latest
      is_cross: false
      artifact_name: windows_x64
      py_version: ${{ inputs.py_version }}
  
  windows_arm64:
    if: ${{ inputs.windows }}
    uses: ./.github/workflows/sbuild-one.yaml
    with:
      os: windows-latest
      params: '--target-cpu arm64'
      cross_tag: win_arm64
      is_cross: true
      artifact_name: windows-cross_arm64
      py_version: ${{ inputs.py_version }}
  
  windows_x86:
    if: ${{ inputs.windows }}
    uses: ./.github/workflows/sbuild-one.yaml
    with:
      os: windows-latest
      params: '--target-cpu x86'
      cross_tag: win32
      is_cross: true
      artifact_name: windows-cross_x86
      py_version: ${{ inputs.py_version }}
  
  # TODO android?
